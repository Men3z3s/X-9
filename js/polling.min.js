/**
 * AJAX long-polling
 *
 * 1. sends a request to the server (without a timestamp parameter)
 * 2. waits for an answer from server.php (which can take forever)
 * 3. if server.php responds (whenever), put data_from_file into #response
 * 4. and call the function again
 *
 * @param stamp
 */

/*jslint browser: true*/
/*jslint node: true*/
/*jslint browser: true*/
/*global $, jQuery, Notification*/

"use strict";

function getContent(timestamp) {
    var queryString = {timestamp: timestamp}, gobs, gstamp,
        notify = function () {
            if (!window.Notification) {
                return;
            }

            if (Notification.permission === 'default') {
                Notification.requestPermission();
            } else if (Notification.permission === 'granted') {
                var notification = new Notification('Uma nova ocorrÃªncia foi aberta.', {
                    body: '',
                    icon: '',
                    tag: gstamp
                });
            } else if (Notification.permission === 'denied') {
                console.log('Denied');
            }
        };

    $.get("polling.php", queryString, function (data) {
        var obj = jQuery.parseJSON(data), i, stamp;

        for (i in obj) {
            if (obj.hasOwnProperty(i)) {
                stamp = obj[i].stamp;
                gstamp = stamp;
                notify();
            }
        }

        getContent(stamp);
    });
}

$(function () {
    getContent();
});

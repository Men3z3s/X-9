/*jslint browser: true*/
/*jslint node: true*/
/*jslint browser: true*/
/*global $, jQuery, alert, btoa*/

"use strict";

$(document).ready(function () {
    var fade = 150, delay = 500, showmap = false, autobusca = true;

    /* MODAL */

    $(".close,.closed").click(function () {
        location.reload();
    });

    /* MASK */

    $("#nascimento-").show(function () {
        $("#nascimento-").mask("99/99/9999");
    });

    $("#cnpj-").show(function () {
        $("#cnpj-").mask("99.999.999/9999-99");
    });

    $("#cpf-").show(function () {
        $("#cpf-").mask("999.999.999-99");
    });

    $("#cep-").show(function () {
        $("#cep-").mask("99999-999");
    });

    $("#telefone-").show(function () {
        $("#telefone-").mask("(99)9999-9999");
    });

    $("#celular-").show(function () {
        $("#celular-").mask("(99)9999-9999");
    });

    $("#valor-, #desconto-").show(function () {
        $("#valor-, #desconto-").maskMoney({
            thousands: '',
            decimal: '.'
        });
    });

    $("#serial-equipamento-, #lan_1-equipamento-, #lan_2-equipamento-, #wlan-equipamento-").show(function() {
        //$('#serial-equipamento-').inputmask('*****-*****-*****-*****-*****');
        $('#serial-equipamento-').inputmask({
            mask: "*****-*****-*****-*****-*****",
            definitions: {
                '*': {
                    casing: "upper"
                }
            }
        });
        $('#lan_1-equipamento-').inputmask('##:##:##:##:##:##');
        $('#lan_2-equipamento-').inputmask('##:##:##:##:##:##');
        $('#wlan-equipamento-').inputmask('##:##:##:##:##:##');
    });

    /* DATEPICKER */

    $("#datado-, #datado-nota-").show(function () {
        $("#datado-, #datado-nota-").datepicker({
            format: 'dd/mm/yyyy',
            todayHighlight: true,
            autoclose: true
        });
    });

    /* NASCIMENTO */

    function validaData() {
        $.post("loadData.php", {
            datado: $.trim($("#nascimento-").val())
        }, function (data) {
            if (data === "true") {
                $("#nascimento-").css("background", "transparent");
                $(".msg-nascimento-").css("display", "none");
            } else {
                $("#nascimento-").focus();
                $("#nascimento-").css("background", "transparent");
                $(".msg-nascimento-").html("Data inv&aacute;lida");
            }
        });
    }

    if (autobusca === true) {
        $("#nascimento-").keyup(function () {
            if ($("#nascimento-").val().length === 10) {
                if ($("#nascimento-").val().match(/_/g)) {
                    console.log('data valida');
                } else {
                    validaData();
                    $("#nascimento-").css("background", "transparent url('img/rings-black.svg') right center no-repeat");
                }
            }
        });
    }

    /* CPF */

    function validaCPF() {
        $.post("loadCpf.php", {
            cpf: $.trim($("#cpf-").val())
        }, function (data) {
            if (data === "true") {
                $("#cpf-").css("background", "transparent");
                $(".msg-documento-").css("display", "none");
            } else {
                $("#cpf-").focus();
                $("#cpf-").css("background", "transparent");
                $(".msg-documento-").html("CPF inv&aacute;lido");
            }
        });
    }

    if (autobusca === true) {
        $("#cpf-").keyup(function () {
            if ($("#cpf-").val().length === 14) {
                if ($("#cpf-").val().match(/_/g)) {
                    console.log('cpf valido');
                } else {
                    validaCPF();
                    $("#cpf-").css("background", "transparent url('img/rings-black.svg') right center no-repeat");
                }
            }
        });
    }

    /* CNPJ */

    function validaCNPJ() {
        $.post("loadCnpj.php", {
            cnpj: $.trim($("#cnpj-").val())
        }, function (data) {
            if (data === "true") {
                $("#cnpj-").css("background", "transparent");
                $(".msg-documento-").css("display", "none");
            } else {
                $("#cnpj-").focus();
                $("#cnpj-").css("background", "transparent");
                $(".msg-documento-").html("CNPJ inv&aacute;lido");
            }
        });
    }

    if (autobusca === true) {
        $("#cnpj-").keyup(function () {
            if ($("#cnpj-").val().length === 18) {
                if ($("#cnpj-").val().match(/_/g)) {
                    console.log('cnpj valido');
                } else {
                    validaCNPJ();
                    $("#cnpj-").css("background", "transparent url('img/rings-black.svg') right center no-repeat");
                }
            }
        });
    }

    /* CEP */

    function buscaCep(showmap) {
        $.post("loadCep.php", {
            cep: $.trim($("#cep-").val())
        }, function (data) {
            var rs = $.parseJSON(data);

            if (rs.resultado === 1) {
                $("#endereco-").val(rs.logradouro + ", ");
                $("#bairro-").val(rs.bairro);
                $("#cidade-").val(rs.cidade);
                $("#estado-").val(rs.uf);
                $("#cep-").css("background", "transparent");
            } else {
                $("#cep-").focus();
                $("#cep-").css("background", "transparent");
                $(".msg-cep-").html("CEP inv&aacute;lido");
            }
        });
    }

    if (autobusca === true) {
        $("#cep-").on("keyup", function () {
            if ($("#cep-").val().length >= 9) {
                if ($("#cep-").val().match(/_/g)) {
                    console.log('cep valido');
                } else {
                    buscaCep(showmap);
                    $("#cep-").css("background", "transparent url('img/rings-black.svg') right center no-repeat");
                }
            }
        });
    }

    /* ICHECK */

    $("input[type='checkbox'], input[type='radio']").show(function () {
        $("input[type='checkbox'], input[type='radio']").iCheck({
            checkboxClass: 'icheckbox_minimal',
            radioClass: 'iradio_minimal'
        });
    });

    $(".control-icheck").show(function () {
        $("#onentrega-").on("ifChecked", function (event) {
            $("#onfechada-").iCheck("disable");
            $("#onretorno-").iCheck("disable");
        });

        $("#offentrega-").on("ifChecked", function (event) {
            $("#onfechada-").iCheck("enable");
            $("#onretorno-").iCheck("enable");
        });

        $("#onfechada-").on("ifChecked", function (event) {
            $("#onentrega-").iCheck("disable");
            $("#onretorno-").iCheck("disable");
        });

        $("#offfechada-").on("ifChecked", function (event) {
            $("#onentrega-").iCheck("enable");
            $("#onretorno-").iCheck("enable");
        });

        $("#onretorno-").on("ifChecked", function (event) {
            $("#onentrega-").iCheck("disable");
            $("#onfechada-").iCheck("disable");
        });

        $("#offretorno-").on("ifChecked", function (event) {
            $("#onentrega-").iCheck("enable");
            $("#onfechada-").iCheck("enable");
        });
    });

    $("#fisica-, #juridica-").show(function () {
        $("#fisica-").on("ifChecked", function (event) {
            $(".label-nome-").html('<i class="fa fa-asterisk"></i> Nome');
            $(".label-nascimento-").html("Nascimento");
            $(".label-documento-").html('<i class="fa fa-asterisk"></i> CPF <cite class="msg-documento- label label-danger"></cite>');
            $(".label-documento-2-").html("RG");

            $("#nome-cliente-").attr("placeholder", "Nome");
            $("#nascimento-").attr("placeholder", "Nascimento");
            $("#cpf-").attr("required", "");
            $("#cnpj-").removeAttr("required", "");

            $("#cpf-, #rg-, .msg-cpf-").removeClass("hide");
            $("#cnpj-, #ie-, .msg-cnpj-").addClass("hide");

            $("#nome-cliente-, #nascimento-, #cnpj-, #ie-, .msg-cnpj-").val("");
        });

        $("#juridica-").on("ifChecked", function (event) {
            $(".label-nome-").html('<i class="fa fa-asterisk"></i> Razão Social');
            $(".label-nascimento-").html("Fundação");
            $(".label-documento-").html('<i class="fa fa-asterisk"></i> CNPJ <cite class="msg-documento- label label-danger"></cite>');
            $(".label-documento-2-").html("IE");

            $("#nome-cliente-").attr("placeholder", "Razão Social");
            $("#nascimento-").attr("placeholder", "Fundação");
            $("#cnpj-").attr("required", "");
            $("#cpf-").removeAttr("required", "");

            $("#cnpj-, #ie-, .msg-cnpj-").removeClass("hide");
            $("#cpf-, #rg-, .msg-cpf-").addClass("hide");

            $("#nome-cliente-, #nascimento-, #cpf-, #rg-, .msg-cpf-").val("");
        });
    });

    /* AUTOCOMPLETE */

    $("#cliente-").show(function () {
        //$("#cliente-").select2();
        $("#cliente-").autocomplete({
            url: "loadCliente.php",
            onItemSelect: function (item) {
                $("#idcliente-").val(item.data);
                $(".msg-cliente-").html("");
                //$("#datado-, #hora-, #tecnico-, #solicitacao-").removeAttr("disabled", "");
            },
            onNoMatch: function () {
                $(".msg-cliente-").html("Cliente n&atilde;o cadastrado");
                //$("#datado-, #hora-, #tecnico-, #solicitacao-").attr("disabled", "");
            }
        });
    });

    /* CALCULOS */

    $("#valor-").keyup(function () {
        var a = $("#valor-").val().replace(',', ''), b = $("#quantidade-").val(), c = a * b, d = $("#desconto-").val(), e;

        if (d !== null) {
            e = c - d;
            e = parseFloat(e).toFixed(2);
            $("#subtotal-").val(e);
        } else {
            $("#subtotal-").val(c);
        }
    });

    $("#quantidade-").keyup(function () {
        var a = $("#valor-").val().replace(',', ''), b = $("#quantidade-").val(), c = a * b, d = $("#desconto-").val(), e;

        if (d !== null) {
            e = c - d;
            e = parseFloat(e).toFixed(2);
            $("#subtotal-").val(e);
        } else {
            $("#subtotal-").val(c);
        }
    });

    $("#desconto-").keyup(function () {
        var a = $("#valor-").val().replace(',', ''), b = $("#quantidade-").val(), c = a * b, d = $("#desconto-").val(), e = c - d;
        e = parseFloat(e).toFixed(2);
        $("#subtotal-").val(e);
    });

    /* INSTALAÇÃO */

    $(".form-install").submit(function (e) {
        e.preventDefault();

        var senha_banco = btoa($("#senha_banco").val()), usuario = btoa($("#usuario").val()), senha = btoa($("#senha").val());

	    $.post("commitAplicativo.php", { servidor: $("#servidor").val(), banco: $("#banco").val(), usuario_banco: $("#usuario_banco").val(), senha_banco: senha_banco, nome: $("#nome").val(), usuario: usuario, senha: senha, email: $("#email").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-install").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'true':
                $.smkAlert({text: 'A instala&ccedil;&atilde;o foi feita com sucesso.', type: 'success', time: 1});
                window.setTimeout("location.href='index.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-install").html('Entrar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* LOGIN */

    $(".form-login").submit(function (e) {
        e.preventDefault();

        var usuario = btoa($("#usuario").val()), senha = btoa($("#senha").val());

	    $.post("trustLogin.php", { usuario: usuario, senha: senha, rand: Math.random()}, function (data) {
            $(".btn-submit-login").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'saude':
                $.smkAlert({text: 'Login efetuado com sucesso.', type: 'success', time: 1});
                window.setTimeout("location.href='equipamento.php'", delay);
                break;
            
            case 'secretaria':
                $.smkAlert({text: 'Login efetuado com sucesso.', type: 'success', time: 1});
                window.setTimeout("location.href='equipamentoSecretaria.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-login").html('Entrar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* RECUPERAR SENHA */

    $(".form-recupera-senha").submit(function (e) {
        e.preventDefault();

	    $.post("recoverSenha.php", { email: $("#email").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-recover").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'true':
                $.smkAlert({text: 'A senha foi enviada para o seu email.', type: 'success', time: 2});
                window.setTimeout("location.href='index.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-recover").html('Recuperar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA NOTA */

    $(".form-edita-nota").submit(function (e) {
        e.preventDefault();

	    $.post("updateNota.php", { idnota: $("#idnota").val(), datado: $("#datado-nota-").val(), tecnico: $("#tecnico-nota-").val(), texto: $("#texto-").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-edita-autor").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'reload':
                $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                location.reload();
                break;
            case 'true':
                $.smkAlert({text: 'Dados da nota editado com sucesso.', type: 'success', time: 2});
                window.setTimeout("location.href='inicio.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-edita-nota").html('Salvar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA TECNICO */

    $(".form-edita-tecnico").submit(function (e) {
        e.preventDefault();

	    $.post("updateTecnico.php", { idtecnico: $("#idtecnico").val(), nome: $("#nome-").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-edita-tecnico").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'reload':
                $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                location.reload();
                break;
            case 'true':
                $.smkAlert({text: 'T&eacute;cnico editado com sucesso.', type: 'success', time: 2});
                window.setTimeout("location.href='tecnico.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-edita-tecnico").html('Salvar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA OCORRENCIA */

    $(".form-edita-ocorrencia").submit(function (e) {
        e.preventDefault();

	    $.post("updateOcorrencia.php", { idocorrencia: $("#idocorrencia").val(), serial: $("#serial-").val(), cliente: $("#cliente-").val(), datado: $("#datado-").val(), hora: $("#hora-").val(), tecnico: $("#tecnico-").val(), solicitacao: $("#solicitacao-").val(), diagnostico: $("#diagnostico-").val(), procedimento: $("#procedimento-").val(), observacao: $("#observacao-").val(), entrega: $("input[name='entrega-']:checked").val(), fechada: $("input[name='fechada-']:checked").val(), retorno: $("input[name='retorno-']:checked").val(), viacliente: $("input[name='viacliente-']:checked").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-edita-ocorrencia").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            if (data === 'true') {
                $.smkAlert({text: 'Ocorr&ecirc;ncia editada com sucesso.', type: 'success', time: 2});
                window.setTimeout("location.href='inicio.php'", delay);
            } else if (data.match(/<url>/g)) {
                $.smkAlert({text: 'Ocorr&ecirc;ncia editada com sucesso.', type: 'success', time: 2});
                data = data.replace("<url>", "");
                data = data.replace("</url>", "");
                //document.location = data;
                window.setTimeout("location.href='" + data + "'", delay);
            } else if (data.match(/<notify>/g)) {
                data = data.replace("<notify>", "");
                data = data.replace("</notify>", "");
                $.smkAlert({text: data, type: 'success', time: 2});
                window.setTimeout("location.href='inicio.php'", 3000);

                /*// Let's check if the browser supports notifications
                if (!("Notification" in window)) {
                    alert("This browser does not support system notifications");
                } else if (Notification.permission === "granted") {
                    // If it's okay let's create a notification
                    var notification = new Notification(data);
                    setTimeout(notification.close.bind(notification), 4000);
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission(function (permission) {
                        // If the user accepts, let's create a notification
                        if (permission === "granted") {
                            var notification = new Notification(data);
                            setTimeout(notification.close.bind(notification), 4000);
                        }
                    });
                }*/
            }  else if (data === 'reload') {
                $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                location.reload();
            } else {
                $.smkAlert({text: data, type: 'warning', time: 3});
            }

            $(".btn-submit-edita-ocorrencia").html('Salvar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA ITEM */

    $(".form-edita-item").submit(function (e) {
        e.preventDefault();

	    $.post("updateItem.php", { idconta: $("#idconta").val(), idocorrencia: $("#idocorrencia").val(), serial: $("#serial").val(), descricao: $("#descricao-").val(), valor: $("#valor-").val(), quantidade: $("#quantidade-").val(), desconto: $("#desconto-").val(), subtotal: $("#subtotal-").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-novo-item").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            if (data.match(/<url>/g)) {
                $.smkAlert({text: 'Item editado com sucesso.', type: 'success', time: 2});
                data = data.replace("<url>", "");
                data = data.replace("</url>", "");
                //document.location = data;
                window.setTimeout("location.href='" + data + "'", delay);
            } else if (data === 'reload') {
                $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                location.reload();
            } else {
                $.smkAlert({text: data, type: 'warning', time: 3});
            }

            $(".btn-submit-edita-item").html('Salvar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA CLIENTE */

    $(".form-edita-cliente").submit(function (e) {
        e.preventDefault();
        var cpf = $("#cpf-").val(), cnpj = $("#cnpj-").val(), rg = $("#rg-").val(), ie = $("#ie-").val(), documento, documento2;

        if (cpf.length > 0) {
            documento = cpf;
        } else {
            documento = cnpj;
        }

        if (rg.length > 0) {
            documento2 = rg;
        } else {
            documento2 = ie;
        }

	    $.post("updateCliente.php", { idcliente: $("#idcliente-").val(), nome: $("#nome-cliente-").val(), nascimento: $("#nascimento-").val(), documento: documento, documento2: documento2, telefone: $("#telefone-").val(), celular: $("#celular-").val(), email: $("#email-").val(), cep: $("#cep-").val(), endereco: $("#endereco-").val(), bairro: $("#bairro-").val(), cidade: $("#cidade-").val(), estado: $("#estado-").val(), observacao: $("#observacao-cliente-").val(), rand: Math.random()}, function (data) {
            $(".btn-submit-edita-cliente").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);

            switch (data) {
            case 'reload':
                $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                location.reload();
                break;
            case 'true':
                $.smkAlert({text: 'Cliente editado com sucesso.', type: 'success', time: 2});
                window.setTimeout("location.href='cliente.php'", delay);
                break;

            default:
                $.smkAlert({text: data, type: 'warning', time: 3});
                break;
            }

            $(".btn-submit-edita-cliente").html('Salvar').fadeTo(fade, 1);
        });

	    return false;
    });

    /* EDITA EQUIPAMENTO */

    $(".form-edita-equipamento").submit(function (e) {
        e.preventDefault();
  
        $.post("updateEquipamento.php", $(this).serialize(), function (data) {
          $(".btn-submit-edit-equipamento").html('<img src="img/rings.svg" class="loader-svg">').fadeTo(fade, 1);
  
            switch (data) {
              /*case 'reload':
                  $.smkAlert({text: 'Nem todos os plugins foram carregados, recarregando...', type: 'danger', time: 2});
                  location.reload();
                  break;*/
  
              case 'true':
                  $.smkAlert({text: 'Equipamento editado com sucesso.', type: 'success', time: 2});
                  window.setTimeout("location.href='equipamento.php'", delay);
                  break;
  
              default:
                  $.smkAlert({text: data, type: 'warning', time: 3});
                  break;
              }
  
              $(".btn-submit-edit-equipamento").html('Salvar').fadeTo(fade, 1);
        });
  
        return false;
      });
});
